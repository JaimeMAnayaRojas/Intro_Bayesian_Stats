# load the packages
library(rethinking)
library(brms)
library('readxl')
rm(list=ls()) # clean the memory of R
data("Howell1") # get the data from the the rethinking package
data <- Howell1
# look at the data
head(data)
hist(data$height)
op<-par(mfrow=c(2,3), mar = c(4, 5, 2, 1), oma = c(1, 1, 1, 1), cex = 0.75)
boxplot(height ~ male, data, ylab = "Height (cm)", xlab = 'Sex', xaxt='n')
axis(1, at = c(1,2), labels = c("Female", "Make"))
plot(height ~ weight, data, pch='', ylab = '')
points(height ~ weight, subset(data, male == 1), pch=21, bg = "tomato")
points(height ~ weight, subset(data, male == 0), pch=21, bg = "cyan")
legend('topleft', legend = c("Male","Female"), pch = 21, pt.bg = c('tomato', 'cyan'), bty = 'n')
plot(height ~ age, data, pch='',  ylab='')
points(height ~ age, subset(data, male == 1), pch=21, bg = "tomato")
points(height ~ age, subset(data, male == 0), pch=21, bg = "cyan")
boxplot(log(height) ~ male, data, ylab = "Height log(cm)", xlab = 'Sex', xaxt='n')
axis(1, at = c(1,2), labels = c("Female", "Make"))
plot(log(height) ~ log(weight), data, pch='', ylab = '')
points(log(height) ~ log(weight), subset(data, male == 1), pch=21, bg = "tomato")
points(log(height) ~ log(weight), subset(data, male == 0), pch=21, bg = "cyan")
plot(log(height) ~ log(age), data, pch='', ylab = '')
points(log(height) ~ log(age), subset(data, male == 1), pch=21, bg = "tomato")
points(log(height) ~ log(age), subset(data, male == 0), pch=21, bg = "cyan")
glimmer(height ~ male, family = gaussian, data = data) # get the structure of the model with the glimmer function
# Run the model with the map2stan function from the rethinking package
m1 <- map2stan(
alist(
height ~ dnorm( mu , sigma ), # likelihood
mu <- Intercept +   b_male*male, # linear model
Intercept ~ dnorm(134,10), # priors for intercept, I know that the mean women's hight is around 134 cm, I am not sure about the sd, so I add a large one
b_male ~ dnorm(0,10), # priors for the slople
sigma ~ dcauchy(0,2) # priors for model error
), data = data, chains = 4, cores = 4, iter = 3000, warmup = 1500, WAIC = TRUE
)
# are the HMC chains mixing well?
tracerplot(m1)
graphics.off()
# summary statistics with High Probability Density Intervals at 95% i.e. Confidence Interval
precis(m1, digits = 5, prob = .95)
m2brms <- brm(height ~ weight_c*male, family = gaussian(), data = data)
# Install the necessary packages
# install.packages(c("coda","mvtnorm","devtools","loo","dagitty", 'rstan', "brms"))
# library(devtools)
# devtools::install_github("rmcelreath/rethinking")
# After installing the packages you can delete  the code above or out comment by adding an # in front of each line or by selecting the lines and
# pressing cntr + shift + c
# load the packages
library(rethinking)
library(brms)
library('readxl')
rm(list=ls()) # clean the memory of R
data("Howell1") # get the data from the the rethinking package
data <- Howell1
# look at the data
head(data)
hist(data$height)
# Make the plots for the presentation
op<-par(mfrow=c(2,3), mar = c(4, 5, 2, 1), oma = c(1, 1, 1, 1), cex = 0.75)
boxplot(height ~ male, data, ylab = "Height (cm)", xlab = 'Sex', xaxt='n')
axis(1, at = c(1,2), labels = c("Female", "Make"))
plot(height ~ weight, data, pch='', ylab = '')
points(height ~ weight, subset(data, male == 1), pch=21, bg = "tomato")
points(height ~ weight, subset(data, male == 0), pch=21, bg = "cyan")
legend('topleft', legend = c("Male","Female"), pch = 21, pt.bg = c('tomato', 'cyan'), bty = 'n')
plot(height ~ age, data, pch='',  ylab='')
points(height ~ age, subset(data, male == 1), pch=21, bg = "tomato")
points(height ~ age, subset(data, male == 0), pch=21, bg = "cyan")
boxplot(log(height) ~ male, data, ylab = "Height log(cm)", xlab = 'Sex', xaxt='n')
axis(1, at = c(1,2), labels = c("Female", "Make"))
plot(log(height) ~ log(weight), data, pch='', ylab = '')
points(log(height) ~ log(weight), subset(data, male == 1), pch=21, bg = "tomato")
points(log(height) ~ log(weight), subset(data, male == 0), pch=21, bg = "cyan")
plot(log(height) ~ log(age), data, pch='', ylab = '')
points(log(height) ~ log(age), subset(data, male == 1), pch=21, bg = "tomato")
points(log(height) ~ log(age), subset(data, male == 0), pch=21, bg = "cyan")
# Question: Do man and women differe in their height?
# Test hypothesis: Males are taller than women:
# Run the model using the Rethingking package
glimmer(height ~ male, family = gaussian, data = data) # get the structure of the model with the glimmer function
# Run the model with the map2stan function from the rethinking package
m1 <- map2stan(
alist(
height ~ dnorm( mu , sigma ), # likelihood
mu <- Intercept +   b_male*male, # linear model
Intercept ~ dnorm(134,10), # priors for intercept, I know that the mean women's hight is around 134 cm, I am not sure about the sd, so I add a large one
b_male ~ dnorm(0,10), # priors for the slople
sigma ~ dcauchy(0,2) # priors for model error
), data = data, chains = 4, cores = 4, iter = 3000, warmup = 1500, WAIC = TRUE
)
# are the HMC chains mixing well?
tracerplot(m1)
graphics.off()
# summary statistics with High Probability Density Intervals at 95% i.e. Confidence Interval
precis(m1, digits = 5, prob = .95)
# What do these results mean?
# Males are coded as 1, and women  as 0, therefore the intercept represent women's height
# The model predicts that a women has a mean height of 134.77 cm, and ranges  from 131.6 to 137.8 with 95% confidence
# Males on the other hand, are between 2.83 to 11.88 cm taller than women with 95% confidence
# the error of the models ranges from 25.8 to 29.06,
# Compare those results with a classical frequentist analysis
summary(lm(height ~ male, data)) # as you can see the results are very similar.
# but the interpretation is a bid different, normally people will read it as:
# Males are significantly than females (F_{1,542} = 10.71p-value < 0.05)
# let's do more things, and test our hypothesis using the posterior samples.
post = extract.samples(m1) # get the posterior samples after the warming period
# Model the height of Males
Males = post$Intercept +  post$b_male * 1 # Estimate men's height from the posterior samples
Females = post$Intercept +  post$b_male * 0 # Estimate women's height from the posterior samples
# What is the probability that males are taller than women?
SexDifference = Males - Females
PP = length(which(SexDifference > 0)) / length(SexDifference) # Number of posterior predicted samples where males are taller than females / total number of samples
PP*100 # the answer is males are defenetly larger than females with a ~100% certainty
# plot those predictions
op<-par(mfrow=c(2,1), mar = c(4, 5, 2, 1), oma = c(1, 1, 1, 1), cex = 1)
dens(Females, show.HPDI = T, show.zero = F, main = "", ylim = c(0,0.4), xlim = c(120,150), xlab = 'Height (cm)',  col = 'blue')
values = round(mean(Females),2)
text(x = mean(Females), y = 0.35, labels = values )
values = paste("(", round(HPDI(Females, prob = .95), 2)[1], " : ", round(HPDI(Females, prob = .95), 2)[2], ")", sep ="" )
text(x = mean(Females), y = 0.3, labels = values )
dens(Males, show.HPDI = T, show.zero = T, main = "Males", ylim = c(0,0.4), xlim = c(120,150), xlab = 'Height (cm)', add = T, col = 'red')
values = round(mean(Males),2)
text(x = mean(Males), y = 0.35, labels = values )
values = paste("(", round(HPDI(Males, prob = .95), 2)[1], " : ", round(HPDI(Males, prob = .95), 2)[2], ")", sep ="" )
text(x = mean(Males), y = 0.3, labels = values )
dens(SexDifference, show.HPDI = T, show.zero = T, xlim=c(-1,18), main = "Males - Females", ylim = c(0,0.25))
values = round(mean(SexDifference),2)
text(x = mean(SexDifference), y = 0.245, labels = values )
values = paste("(", round(HPDI(SexDifference, prob = .95), 2)[1], " : ", round(HPDI(SexDifference, prob = .95), 2)[2], ")", sep ="" )
text(x = mean(SexDifference), y = 0.2, labels = values )
# let's plot the results in another way
# Make a barplot
df = data.frame(male = c(0,1), mean = c(mean(Females), mean(Males)),
LC = c(HPDI(Females, prob = .95)[1], HPDI(Males, prob = .95)[1]),
UC = c(HPDI(Females, prob = .95)[2], HPDI(Males, prob = .95)[2]))
df
graphics.off()
plot(height ~ male, data, pch='', xaxt='n', ylim = c(min(df$LC), max(df$UC)), xlab = "Sex", ylab = 'Height (cm)')
axis(1, at = c(0.25,0.75), labels = c("Female", "Make"))
segments(x0 =c(0.25,0.75), x1 =c(0.25,0.75), y0 = df$LC, y1=df$UC)
segments(x0 =c(0.25), x1 =c(0.75), y0 = df$mean[1], y1=df$mean[2])
points(df$mean ~ c(0.25,0.75), cex = 2, pch =21, bg = 'gray' )
# let's as other questions
#  is the relationship between body weight and height different between males and females?
# let's use only the data for people older than 18
data <- subset(data, age >= 18)
data$weight_c =(data$weight) - 45 # center at 45 kg
# why do we center? because it help us to make sence of the data
op<-par(mfrow=c(2,1), mar = c(4, 5, 2, 1), oma = c(1, 1, 1, 1), cex = 1)
plot(data$height ~ data$weight)
abline(v=45)
# By centering at 45 Kg, we force the intercept to be at 45 Kg and not at a crazy
summary(lm(height ~ weight, data)) # here the model predicts that a person with 0 Kg should be 113.87 cm, that just doesn't make sence
# additionally, it also says that by each 1 Kg she/he will grow 0.9cm.
plot(data$height ~ data$weight_c)
abline(v=0)
summary(lm(height ~ weight_c, data)) # here the model predicts that a 45 Kg person should be 154.6 cm, that makes more sence
# additionally, it also says that by each 1 Kg she/he gains will grow 0.9 cm.
m2 <- map2stan(
alist(
height ~ dnorm( mu , sigma ), # likelihood
mu <- Intercept + b_weight*weight_c + b_male*male + b_WxM * (weight_c*male), # linear model, including an interaction term
Intercept ~ dnorm(134,100), # priors for intercept
b_male ~ dnorm(0,10), # priors for the slople
b_weight ~ dnorm(0,10), # priors for the slople
b_WxM ~ dnorm(0,10), # priors for the slople
sigma ~ dcauchy(0,10) # priors for model error
), data = data, chains = 4, cores = 4, iter = 3000, warmup = 1500, WAIC = TRUE
)
m2brms <- brm(height ~ weight_c*male, family = gaussian(), data = data)
summary(m2brms)
precis(m2, digits = 5, prob = .95) # summary statistics with High Probability Density Intervals at 95% i.e. Confidence Interval
summary(m2brms)
